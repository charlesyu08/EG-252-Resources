<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Dr K. S. (Joseph) Kim">
  <meta name="author" content="Dr Chris P. Jobling">
  <title>Exercise 2: Keyboard Interrupt</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
</head>
<body>
<header>
<h1 class="title">Exercise 2: Keyboard Interrupt</h1>
<h1 class="subtitle">EG-252 Group Design Exercise – Microcontroller Laboratory</h1>
<h2 class="author">Dr K. S. (Joseph) Kim</h2>
<h2 class="author">Dr Chris P. Jobling</h2>
<h3 class="date">September 2014</h3>
</header>
<h1 id="exercise-2-keyboard-interrupt">Exercise 2: Keyboard Interrupt</h1>
<p>For this exercise you are provided sample keyboard interrupt programs in both C and Assembly in the appendices; make sure that you have downloaded electronic versions of the program from the <a href="https://github.com/cpjobling/EG-252-Resources/tree/master/Microcontroller-Interfacing/Exercises/Exercise2">GitHub repository</a> before the exercise. The program uses the interrupt generated by push buttons to switch on/off the LEDs on the MC9S08AW60 evaluation board.</p>
<p>You are to carry out the following three tasks with this exercise:</p>
<ul>
<li>Use the sample program to practice using interrupt mechanism to interface peripheral devices with the evaluation board.</li>
<li>Answer the questions related to the CPU interrupt procedure (3 marks given on the final report).</li>
<li>Adjust the sample program to use the onboard switches to control the display of your student number (7 marks, with 4 marks given on demonstration and 3 marks given on the final report).</li>
</ul>
<p>The demonstration of your program on the board needs to be done no later than <em>Monday, 10 November 2014</em>.</p>
<p>You can view this document as a web page <a href="exercise2.html">HTML</a>, <a href="exercise2.pdf">PDF</a> or as a Word Document <a href="exercise2.docx">.docx</a></p>
<h2 id="i.-experiment-with-the-sample-program">I. Experiment with the Sample Program</h2>
<p>The sample program, “<a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.c">kbi_interrupt.c</a>” and “<a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.asm">kbi_interrupt.asm</a>”, flashes onboard LEDs upon the interrupt requests generated by the keyboard inputs, which are <code>SW3</code> and <code>SW4</code> used as keyboard inputs 6 and 5, respectively. The flowchart of the program is shown in Figure 1. Enter it or copy the electronic file onto your CodeWarrior project, which is created targeting on HCS08 CPU family and MC9S08AW60 MCU.</p>
<pre><code>Start
Port initialization:
PTFDD=$FF
PTDPE=$FF
LED_on=$0F
KBI initialization:
KBI1PE=$60;
Set KBI1SC bits 1 and 2
Unmask CPU interrupts:
CLI
Read LED_on
Mainloop
Main Program
Start
Clear KBI flag:
Set bit 2 of KBI1SC
Toggle bits of LED_on:
LED_on=LED_on XOR $FF
Output to light LEDs:
PTFD = LED_on
Interrupt service routine
RTI</code></pre>
<p>Figure 1. Flowchart of keyboard interrupt program</p>
<p>After you create your own keyboard interrupt project, you can use the evaluation board to debug the sample keyboard interrupt program. Next we will introduce how to use evaluation board to configure peripheral device inputs and generate interrupts.</p>
<h3 id="a.-interrupt-generation-with-the-evaluation-board">A. Interrupt Generation with the Evaluation Board</h3>
<p>The evaluation board includes four pushbutton switches (<code>SW1</code>-<code>SW4</code>) which can provide momentary active low input for user applications. <code>SW3</code> and <code>SW4</code> are connected to MCU Port <code>PTD3</code> and <code>PTD2</code> respectively. If the pins of <code>PTD3</code> and <code>PTD2</code> are configured as KBI inputs, they will be read with “1” if the corresponding pushbutton is not pressed and “0” if pressed. Edge events and edge/level events can be easily generated by pressing <code>SW3</code> and <code>SW4</code>. The KBI inputs can detect the selected events as configured by the programmer and generate interrupt requests if keyboard interrupt for the inputs is enabled.</p>
<h3 id="b.-experiment-with-the-interrupt-mechanism">B. Experiment with the Interrupt Mechanism</h3>
<p>Once we know how to generate keyboard interrupt events, we can use the sample program and evaluation board kits to experiment with interrupt mechanism.</p>
<p>According to the interrupt procedure, CPU will leave the main program and run the interrupt service routine (ISR) if interrupt for the keyboard module is enabled. You can use “Single step” or set breakpoint(s) to observe how the CPU responds to interrupt requests. After the CPU finishes the ISR, it returns to the main program. You can generate as many keyboard interrupts as you like by pushing down the switches.</p>
<p>You can also experiment with detection of rising edge and rising edge/high level events and correspondingly generating keyboard interrupt events by configuring the keyboard interrupt status and control register.</p>
<h2 id="ii.-questions">II. Questions</h2>
<p>By doing experiments with either slightly modified sample C or assembly program, you are required to answer the following questions.</p>
<ol type="1">
<li><p>Upon the generation of keyboard interrupt requests, the ISR will be run by the CPU. Experiment with evaluation board, record and compare the content in the stack just before and after the CPU enter the ISR, just before and after the CPU leaves the ISR corresponding to a keyboard interrupt. You can get stack pointer value from register panel in real-time debugger window.</p></li>
<li><p>Explain why the stack content may change as you have observed.</p></li>
</ol>
<h2 id="iii.-adjust-the-sample-program-to-display-your-student-numbers">III. Adjust the Sample Program to Display your Student Numbers</h2>
<p>All the eight KBI inputs share the KBI source. In this task you are required to adjust the ISR shown in the Appendix, in order to determine which of the two pushbuttons <code>SW3</code> and <code>SW4</code> triggered a KBI interrupt and correspondingly display a student number of a member in your team.</p>
<p>Suppose the student numbers for your team are 43210 and 12345, respectively. On reset, if pushbutton <code>SW3</code> is pressed down, in your ISR you should light up the leftmost nonzero digit 4 in the first student number over LEDs (i.e., in a binary format using four LEDs). Then the CPU should leave the ISR and return to the main program. If <code>SW3</code> is released and then pressed down again, the next digit 3 in the first student should be displayed over LED in your ISR. With more pressing of SW3, the following digits in the first student number are displayed sequentially. Note that after the rightmost digit 0 was displayed over LEDs upon the last pressing of <code>SW3</code>, the leftmost digit 4 will be displayed over LEDs upon new <code>SW3</code> pressing. Similar operations are performed for the second student number 12345 if pushbutton <code>SW4</code> is pressed.</p>
<p>You are required to design and debug the ISR program (using either Assembly or C language), and demonstrate the application to Dr Chris Jobling or Dr Tim Davies.</p>
<h2 id="appendix-a">Appendix A</h2>
<h3 id="sample-program-in-c">Sample Program in C</h3>
<table class="sourceCode c numberLines" id="kbi_interrupt_c"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="sourceCode"><pre><code class="sourceCode c"><span class="co">/* kbi_interrupt.c */</span>

<span class="ot">#include &lt;hidef.h&gt;    </span><span class="co">/* for EnableInterrupts macro */</span>
<span class="ot">#include &quot;derivative.h&quot; </span><span class="co">/* include peripheral declarations */</span>

<span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">char</span> muint8;
<span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">short</span> muint16;
<span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">long</span> muint32;

<span class="kw">typedef</span> <span class="dt">char</span> mint8;
<span class="kw">typedef</span> <span class="dt">short</span> mint16;
<span class="kw">typedef</span> <span class="dt">long</span> mint32;

<span class="co">/* to clear or set single bits in a byte variable */</span>
<span class="ot">#define b_SetBit(bit_ID, varID)   (varID |= (muint8)(1&lt;&lt;bit_ID))</span>
<span class="ot">#define b_ClearBit(bit_ID, varID) (varID &amp;= ~(muint8)(1&lt;&lt;bit_ID))</span>
<span class="ot">#define b_XorBit(bit_ID, varID)   (varID ^= (muint8)(1&lt;&lt;bit_ID))</span>

muint8 LED_onseq;

<span class="dt">void</span> main(<span class="dt">void</span>) {
  EnableInterrupts; <span class="co">/* enable interrupts */</span>
  SOPT = <span class="bn">0x00</span>;    <span class="co">/* disable COP */</span>

  <span class="co">/* begin LED/switch test */</span>

  PTDPE = <span class="bn">0xFF</span>;   <span class="co">/* enable port D pullups for push button switch interrupt */</span>

  <span class="co">/* Init_GPIO init code */</span>
  PTFDD = <span class="bn">0xFF</span>;   <span class="co">/* set port F as outputs for LED operation */</span>
  LED_onseq = <span class="bn">0x0F</span>; <span class="co">/* initialize LED_onseq */</span>

  <span class="co">/* enable interrupt for keyboard input */</span>
  b_ClearBit(<span class="dv">1</span>, KBI1SC);  <span class="co">/* KBI1SC: KBIE=0, disable KBI interrupt request */</span>
  KBI1PE = <span class="bn">0x60</span>;      <span class="co">/* KBI1PE: KBIPE7=1, enable KBI function for pins 5 and 6 only */</span>
  b_ClearBit(<span class="dv">0</span>, KBI1SC);  <span class="co">/* KBI1SC: KBIMOD=0, select edge-only detection */</span>
  
  <span class="co">/* in defaut only falling edge events to be detected */</span>
  b_SetBit(<span class="dv">2</span>, KBI1SC);  <span class="co">/* KBI1SC: KBACK=1, to clear KBI flag */</span>
  b_SetBit(<span class="dv">1</span>, KBI1SC);  <span class="co">/* KBI1SC: KBIE=1, enable KBI */</span>

  <span class="kw">for</span>(;;) {
    __RESET_WATCHDOG(); <span class="co">/* feeds the dog */</span>
  } <span class="co">/* loop forever */</span>
    <span class="co">/* please make sure that you never leave main */</span>
}

interrupt <span class="dv">22</span> <span class="dt">void</span> intKBI_SW(){
  KBI1SC_KBACK = <span class="dv">1</span>; <span class="co">/*acknowledge interrupt*/</span>
  PTFD = LED_onseq;
  LED_onseq ^= <span class="bn">0xFF</span>;  <span class="co">/* toggle LED_onseq bits */</span>
}</code></pre></td></tr></table>
<p>View on <a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.c">GitHub</a></p>
<h2 id="appendix-b">Appendix B</h2>
<h3 id="sample-program-in-assembly">Sample Program in Assembly</h3>
<table class="sourceCode assembly numberLines" id="kbi_interrupt_asm"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="sourceCode"><pre><code class="sourceCode">;*************************************************************************
;*  kbi_interrupt.asm                                                    *
;*                                                                       *
;*  MC9S08AW60 Evaluation board keyboard interrupt example               *
;*  - Switch SW3 onboard connected to Port D pin 3, KBI pin6;            *
;*  - Switch SW4 onboard connected to Port D pin 2, KBI pin5             *
;*                                                                       *
;*  Function:                                                            *
;*  on reset all LEDs will light on. If SW3 or SW4 pressed,              *
;*  an interrupt is generated, which set LEDs 0:3 to light on.           *
;*  More interrupts are genereated if SW3 or SW4 are pressed.            *
;*************************************************************************

; Include derivative-specific definitions
    INCLUDE &#39;derivative.inc&#39;

FLASH EQU   $2000
RAM   EQU   $0070
WATCH EQU   $1802

    ORG   RAM
LED_on  DS.B  1               ; Define a variable VAR_D with a size of 1 byte

;Start program after reset
    ORG   FLASH
START_UP
    LDA   #$00
    STA   WATCH     ; Turn off the watchdog timer
    
;Init_GPIO init code 
    LDA     #$FF
    STA     PTFDD
    MOV     #$0F, LED_on    ; Initialize VAR_D, used to control the LEDs
    LDA     #$FF
    STA     PTDPE           ; Port D is enabled with pull-up
    RSP           ; Reset stack pointer
                
;Enable interrupt for Keyboard input
    LDA     #$60
    STA     KBI1PE           ; KBI1PE: KBIPE7=1, enable KBI function for pins 5 and 6 only
    BSET    $02, KBI1SC      ; KBI1SC: KBACK=1, to clear KBI flag 
    BSET    $01, KBI1SC      ; KBI1SC: KBIE=1, enable KBI 
                               
    CLI                      ; Enable interrupt

MAINLOOP
    LDA     LED_on           ; Simple routine
    BRA   MAINLOOP

;Interrupt service routine for a keyboard interrupt generated upon the press of a pushbutton
;with a falling edge (transition from high logic level &quot;1&quot; to low logic level &quot;0&quot;)
LED_SWITCH
    BSET    $02, KBI1SC     ; clear KBI flag 
    LDA     LED_on
    EOR     #$FF            ; Toggle bits in VAR_D
    STA     PTFD            ; Output to light LEDs (port F)
    STA     LED_on          ; Store the new value to VAR_D

    RTI

;INT_VECTOR
    ORG     $FFD2
    DC.W    LED_SWITCH

    ORG     $FFFE
    DC.W    START_UP</code></pre></td></tr></table>
<p>View on <a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.asm">GitHub</a></p>
</body>
</html>
