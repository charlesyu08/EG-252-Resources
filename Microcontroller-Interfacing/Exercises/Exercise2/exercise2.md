---
title:  'Exercise 2: Keyboard Interrupt'
subtitle: 'EG-252 Group Design Exercise -- Microcontroller Laboratory'
author:
  - Dr K. S. (Joseph) Kim
  - Dr Chris P. Jobling
affiliation: Swansea University
tags: [eg-252, microcontrollers laboratory, keyboard interrupt]
date: September 2014
...

# Exercise 2: Keyboard Interrupt

For this exercise you are provided sample keyboard interrupt programs in both C
and Assembly in the appendices; make sure that you have downloaded electronic
versions of the program from the [GitHub repository](https://github.com/cpjobling/EG-252-Resources/tree/master/Microcontroller-Interfacing/Exercises/Exercise2)
before the exercise. The program uses the interrupt generated by push buttons to switch on/off the LEDs
on the MC9S08AW60 evaluation board.

You are to carry out the following three tasks with this exercise:

- Use the sample program to practice using interrupt mechanism to interface peripheral devices with
the evaluation board.
- Answer the questions related to the CPU interrupt procedure (3 marks given on the final report).
- Adjust the sample program to use the onboard switches to control the display of your student number (7 marks, with 4 marks given on demonstration and 3 marks given on the final report).

The demonstration of your program on the board needs to be done no later than *Monday, 10 November 2014*.

You can view this document as a web page [HTML](exercise2.html), [PDF](exercise2.pdf) or as a Word Document [.docx](exercise2.docx)


## I. Experiment with the Sample Program

The sample program,
"[kbi_interrupt.c](https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.c)" and
"[kbi_interrupt.asm](https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.asm)", flashes
onboard LEDs upon the interrupt requests generated by the keyboard inputs, which
are `SW3` and `SW4` used as keyboard inputs 6 and 5, respectively. The flowchart
of the program is shown in Figure 1. Enter it or copy the electronic file onto
your CodeWarrior project, which is created targeting on HCS08 CPU family and
MC9S08AW60 MCU.

```
Start
Port initialization:
PTFDD=$FF
PTDPE=$FF
LED_on=$0F
KBI initialization:
KBI1PE=$60;
Set KBI1SC bits 1 and 2
Unmask CPU interrupts:
CLI
Read LED_on
Mainloop
Main Program
Start
Clear KBI flag:
Set bit 2 of KBI1SC
Toggle bits of LED_on:
LED_on=LED_on XOR $FF
Output to light LEDs:
PTFD = LED_on
Interrupt service routine
RTI
```
Figure 1. Flowchart of keyboard interrupt program

After you create your own keyboard interrupt project, you can use the evaluation
board to debug the sample keyboard interrupt program. Next we will introduce how
to use evaluation board to configure peripheral device inputs and generate
interrupts.

### A. Interrupt Generation with the Evaluation Board

The evaluation board includes four pushbutton switches (`SW1`-`SW4`) which can
provide momentary active low input for user applications. `SW3` and `SW4` are
connected to MCU Port `PTD3` and `PTD2` respectively. If the pins of `PTD3` and
`PTD2` are configured as KBI inputs, they will be read with "1" if the
corresponding pushbutton is not pressed and "0" if pressed. Edge events and
edge/level events can be easily generated by pressing `SW3` and `SW4`. The KBI
inputs can detect the selected events as configured by the programmer and
generate interrupt requests if keyboard interrupt for the inputs is enabled.

### B. Experiment with the Interrupt Mechanism

Once we know how to generate keyboard interrupt events, we can use the sample
program and evaluation board kits to experiment with interrupt mechanism.

According to the interrupt procedure, CPU will leave the main program and run
the interrupt service routine (ISR) if interrupt for the keyboard module is
enabled. You can use “Single step” or set breakpoint(s) to observe how the CPU
responds to interrupt requests. After the CPU finishes the ISR, it returns to
the main program. You can generate as many keyboard interrupts as you like by
pushing down the switches. 

You can also experiment with detection of rising edge and rising edge/high level
events and correspondingly generating keyboard interrupt events by configuring
the keyboard interrupt status and control register.

## II. Questions

By doing experiments with either slightly modified sample C or assembly program, you are required
to answer the following questions.

1) Upon the generation of keyboard interrupt requests, the ISR will be run by
the CPU. Experiment with evaluation board, record and compare the content in the
stack just before and after the CPU enter the ISR, just before and after the CPU
leaves the ISR corresponding to a keyboard interrupt. You can get stack pointer
value from register panel in real-time debugger window.

2) Explain why the stack content may change as you have observed.

## III. Adjust the Sample Program to Display your Student Numbers

All the eight KBI inputs share the KBI source. In this task you are required to
adjust the ISR shown in the Appendix, in order to determine which of the two
pushbuttons `SW3` and `SW4` triggered a KBI interrupt and correspondingly display a
student number of a member in your team.

Suppose the student numbers for your team are 43210 and 12345, respectively. On
reset, if pushbutton `SW3` is pressed down, in your ISR you should light up the
leftmost nonzero digit 4 in the first student number over LEDs (i.e., in a
binary format using four LEDs). Then the CPU should leave the ISR and return to
the main program. If `SW3` is released and then pressed down again, the next
digit 3 in the first student should be displayed over LED in your ISR. With more
pressing of SW3, the following digits in the first student number are displayed
sequentially. Note that after the rightmost digit 0 was displayed over LEDs upon
the last pressing of `SW3`, the leftmost digit 4 will be displayed over LEDs upon
new `SW3` pressing. Similar operations are performed for the second student
number 12345 if pushbutton `SW4` is pressed.

You are required to design and debug the ISR program (using either Assembly or C
language), and demonstrate the application to Dr Chris Jobling or Dr Tim Davies.

## Appendix A
### Sample Program in C

~~~~{include="kbi_interrupt.c" #kbi_interrupt_c .c .numberLines}
/* kbi_interrupt.c */
~~~~~~~~~~
View on [GitHub](https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.c)

## Appendix B
### Sample Program in Assembly
~~~~{include="kbi_interrupt.asm" #kbi_interrupt_asm .assembly .numberLines}
kbi_interrupt.asm expands here
~~~~~~~~~~
View on [GitHub](https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise2/kbi_interrupt.asm)
